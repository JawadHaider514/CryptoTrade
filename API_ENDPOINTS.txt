API ENDPOINTS SUMMARY
====================

Updated: December 27, 2025
File: src/crypto_bot/server/advanced_web_server.py

All endpoints use PredictionMapper for unified schema normalization.
All timestamps use ISO format: YYYY-MM-DDTHH:MM:SSZ (no space before Z)
All endpoints include 'source' field: PRO, DASHBOARD, or FALLBACK

================================================================================
1. GET /api/predictions
================================================================================

Returns: Object keyed by symbol with unified predictions

Response:
{
  "success": true,
  "predictions": {
    "BTCUSDT": {
      "symbol": "BTCUSDT",
      "timeframe": "15m",
      "source": "PRO",
      "direction": "LONG",
      "entry_price": 42500.50,
      "stop_loss": 42000.00,
      "take_profits": [
        {"level": 1, "price": 43000.00, "eta": "2025-12-27T09:15:51Z"},
        {"level": 2, "price": 43500.00, "eta": "2025-12-27T09:25:51Z"},
        {"level": 3, "price": 44000.00, "eta": "2025-12-27T09:55:51Z"}
      ],
      "confidence_score": 77,
      "accuracy_percent": 90.0,
      "leverage": 20,
      "current_price": 42500.50,
      "timestamp": "2025-12-27T09:10:51Z",
      "valid_until": "2025-12-27T13:10:51Z",
      "reasons": ["Pattern detected"],
      "patterns": ["head_and_shoulders"],
      "market_context": "Bullish trend"
    },
    "ETHUSDT": { ... }
  },
  "count": 2,
  "warming_up": false,
  "timestamp": "2025-12-27T09:10:51Z"
}

CRITICAL: This endpoint NEVER returns 503
- If no predictions ready: returns { success:true, predictions:{}, warming_up:true }
- If error occurs: returns { success:true, predictions:{}, warming_up:true }
- Always returns HTTP 200

================================================================================
2. GET /api/predictions/<symbol>
================================================================================

Returns: Single prediction for symbol (or null if not available)

Example: GET /api/predictions/BTCUSDT

Response:
{
  "success": true,
  "symbol": "BTCUSDT",
  "prediction": {
    "symbol": "BTCUSDT",
    "timeframe": "15m",
    "source": "PRO",
    "direction": "LONG",
    ...
  },
  "timestamp": "2025-12-27T09:10:51Z"
}

================================================================================
3. GET /api/signals
================================================================================

Backwards compatibility endpoint
Returns: predictions as array (Object.values(predictions))

Response:
{
  "success": true,
  "signals": [
    {
      "symbol": "BTCUSDT",
      "timeframe": "15m",
      "source": "PRO",
      ...
    },
    {
      "symbol": "ETHUSDT",
      "timeframe": "15m",
      "source": "DASHBOARD",
      ...
    }
  ],
  "count": 2,
  "warming_up": false,
  "timestamp": "2025-12-27T09:10:51Z"
}

================================================================================
4. GET /api/prices
================================================================================

Returns: All current prices

Response:
{
  "success": true,
  "prices": {
    "BTCUSDT": 42500.50,
    "ETHUSDT": 2200.75,
    "BNBUSDT": 600.25
  },
  "timestamp": "2025-12-27T09:10:51Z"
}

================================================================================
5. GET /api/health
================================================================================

Returns: Server status with counts

Response:
{
  "success": true,
  "status": "running",
  "services": {
    "MarketDataService": "running",
    "SignalEngineService": "running",
    "SignalRepository": "running"
  },
  "cached_predictions": 15,
  "symbols_count": 35,
  "timestamp": "2025-12-27T09:10:51Z"
}

================================================================================
UNIFIED PREDICTION SCHEMA
================================================================================

All predictions use this normalized schema (from PredictionMapper):

{
  "symbol": "ATOMUSDT",
  "timeframe": "15m",
  "source": "PRO",  // or "DASHBOARD" or "FALLBACK"
  "direction": "LONG",  // or "SHORT"
  "entry_price": 2.031,
  "stop_loss": 1.99038,
  "take_profits": [
    {"level": 1, "price": 2.05131, "eta": "2025-12-27T09:15:51Z"},
    {"level": 2, "price": 2.07162, "eta": "2025-12-27T09:25:51Z"},
    {"level": 3, "price": 2.09193, "eta": "2025-12-27T09:55:51Z"}
  ],
  "confidence_score": 77,  // 0-100
  "accuracy_percent": 90.0,  // 0-100
  "leverage": 20,  // 1-125
  "current_price": 2.031,
  "timestamp": "2025-12-27T09:10:51Z",
  "valid_until": "2025-12-27T13:10:51Z",
  "reasons": ["Array of analysis reasons"],
  "patterns": ["Array of detected patterns"],
  "market_context": "String describing market state"
}

================================================================================
DATETIME FORMAT
================================================================================

Rule: All timestamps MUST be ISO format with Z suffix

Correct:   "2025-12-27T09:10:51Z"  ✅
Wrong:     "2025-12-27T09:10:51"   ❌ (missing Z)
Wrong:     "2025-12-27 09:10:51Z"  ❌ (space instead of T)
Wrong:     "2025-12-27T09:10:51 Z" ❌ (space before Z)

All datetimes use PredictionMapper._to_iso_string(datetime_obj)

================================================================================
SOURCE FIELD VALUES
================================================================================

PRO
- Professional Analyzer result
- Highest confidence (typically 70%+)
- Uses 6-timeframe analysis (1m, 5m, 15m, 1h, 4h, 1d)
- 5+ year trader logic

DASHBOARD
- Enhanced Dashboard Analyzer fallback
- Medium-high confidence
- Used when Professional Analyzer unavailable

FALLBACK
- Minimal neutral signal (last resort)
- Very low confidence (typically 10-25%)
- Used when all other analyzers fail
- Direction always LONG, leverage 1x

================================================================================
ERROR HANDLING
================================================================================

Critical Rule: /api/predictions NEVER returns 503

If services not initialized:
  HTTP 200: { success:true, predictions:{}, warming_up:true }

If mapper error:
  HTTP 200: { success:true, predictions:{}, warming_up:true }

If database error:
  HTTP 200: { success:true, predictions:{}, warming_up:true }

Any unhandled exception:
  HTTP 200: { success:true, predictions:{}, warming_up:true }

This ensures frontend never breaks waiting for predictions.

================================================================================
